{% extends "base.html" %}

{% block title %}Model Ayarlarƒ± - Tahmin{% endblock %}

{% block content %}
<div class="container">
    <div class="row">
        <div class="col-lg-12">
            <div class="card">
                <div class="card-header">
                    <h3 class="card-title">
                        <i class="fas fa-cogs"></i>
                        Model Konfig√ºrasyonu
                    </h3>
                    <p class="card-subtitle">Dosya: <strong>{{ filename }}</strong> | Toplam: {{ total_rows }} satƒ±r</p>
                </div>
                <div class="card-body">
                    
                    <!-- Se√ßim √ñzeti -->
                    <div class="row mb-4">
                        <div class="col-md-6">
                            <div class="alert alert-info">
                                <h6><i class="fas fa-bullseye"></i> Hedef Kolon</h6>
                                <strong>{{ target_column }}</strong>
                                {% if missing_data[target_column]['count'] > 0 %}
                                <br><small class="text-warning">‚ö†Ô∏è {{ missing_data[target_column]['count'] }} eksik veri ({{ missing_data[target_column]['percentage'] }}%)</small>
                                {% endif %}
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="alert alert-success">
                                <h6><i class="fas fa-list-check"></i> √ñzellik Kolonlarƒ±</h6>
                                {% for feature in feature_columns %}
                                <strong>{{ feature }}</strong>{% if not loop.last %}, {% endif %}
                                {% if missing_data[feature]['count'] > 0 %}
                                <br><small class="text-warning">‚ö†Ô∏è {{ missing_data[feature]['count'] }} eksik veri ({{ missing_data[feature]['percentage'] }}%)</small>
                                {% endif %}
                                {% endfor %}
                            </div>
                        </div>
                    </div>

                    <!-- Model Ayarlarƒ± Formu -->
                    {% if prediction_mode %}
                    <!-- PREDICTION MODE: Model eƒüitimi yok, sadece devam et -->
                    <div class="alert alert-info">
                        <h6><i class="fas fa-info-circle"></i> Tahmin Modu</h6>
                        <p>Mevcut eƒüitilmi≈ü model kullanƒ±lacak. Yeni model eƒüitimi yapƒ±lmayacak.</p>
                        <p><strong>Model:</strong> {{ session.prediction_model.model_type|title if session.prediction_model else 'Bilinmiyor' }}</p>
                    </div>
                    
                    <form method="POST">
                        <!-- Butonlar -->
                        <div class="row mt-4">
                            <div class="col-12">
                                <div class="d-flex justify-content-between">
                                    <a href="{{ url_for('processing.select_columns', filename=filename) }}" class="btn btn-secondary">
                                        <i class="fas fa-arrow-left"></i> Geri
                                    </a>
                                    <button type="submit" class="btn btn-primary btn-lg">
                                        <i class="fas fa-calculator"></i> Tahmin Yap
                                    </button>
                                </div>
                            </div>
                        </div>
                    </form>
                    
                    {% else %}
                    <!-- NORMAL MODE: Model eƒüitimi -->
                    <form method="POST" action="{{ url_for('training.train_model') }}">
                        <div class="row">
                            <!-- Model T√ºr√º -->
                            <div class="col-md-4">
                                <div class="form-group">
                                    <label for="model_type">
                                        <i class="fas fa-robot"></i>
                                        Model T√ºr√º
                                    </label>
                                    <select name="model_type" id="model_type" class="form-control" required>
                                        <option value="linear_regression">Linear Regression</option>
                                        <option value="ridge">Ridge Regression</option>
                                        <option value="lasso">Lasso Regression</option>
                                        <option value="random_forest">Random Forest</option>
                                        <option value="xgboost">XGBoost</option>
                                        <option value="decision_tree">Decision Tree</option>
                                    </select>
                                    <small class="form-text text-muted" id="model-info">
                                        Ba≈ülangƒ±√ß i√ßin Linear Regression √∂nerilir.
                                    </small>
                                </div>
                            </div>

                            <!-- Test Veri Oranƒ± -->
                            <div class="col-md-4">
                                <div class="form-group">
                                    <label for="test_size">
                                        <i class="fas fa-chart-pie"></i>
                                        Test Veri Oranƒ±
                                    </label>
                                    <select name="test_size" id="test_size" class="form-control">
                                        <option value="0.1">%10 (Daha √ßok eƒüitim verisi)</option>
                                        <option value="0.2" selected>%20 (√ñnerilen)</option>
                                        <option value="0.3">%30 (Daha √ßok test verisi)</option>
                                    </select>
                                    <small class="form-text text-muted">
                                        Verinin ne kadarƒ± test i√ßin ayrƒ±lacak.
                                    </small>
                                </div>
                            </div>

                            <!-- Eksik Veri ƒ∞≈üleme -->
                            <div class="col-md-4">
                                <div class="form-group">
                                    <label for="handle_missing">
                                        <i class="fas fa-question-circle"></i>
                                        Eksik Veri ƒ∞≈üleme
                                    </label>
                                    <select name="handle_missing" id="handle_missing" class="form-control">
                                        <option value="drop">Eksik satƒ±rlarƒ± sil</option>
                                        <option value="mean">Ortalama ile doldur</option>
                                        <option value="median">Medyan ile doldur</option>
                                    </select>
                                    <small class="form-text text-muted">
                                        Eksik veriler nasƒ±l i≈ülensin?
                                    </small>
                                </div>
                            </div>
                        </div>

                        <!-- Model Parametreleri (Dinamik) -->
                        <div class="row">
                            <div class="col-md-4" id="model-params-container">
                                <!-- Ridge Alpha Parametresi -->
                                <div class="form-group" id="ridge-alpha-param" style="display: none;">
                                    <label for="ridge_alpha_input">
                                        <i class="fas fa-sliders-h"></i>
                                        Alpha (D√ºzenleme Katsayƒ±sƒ±)
                                    </label>
                                    <input type="number" name="" id="ridge_alpha_input" class="form-control" 
                                           value="1.0" min="0.001" max="100" step="0.1" disabled>
                                    <small class="form-text text-muted">
                                        D√º≈ü√ºk deƒüer (0.1): Az d√ºzenleme, y√ºksek deƒüer (10): √áok d√ºzenleme
                                    </small>
                                </div>
                                
                                <!-- Lasso Alpha Parametresi -->
                                <div class="form-group" id="lasso-alpha-param" style="display: none;">
                                    <label for="lasso_alpha_input">
                                        <i class="fas fa-sliders-h"></i>
                                        Alpha (L1 D√ºzenleme Katsayƒ±sƒ±)
                                    </label>
                                    <input type="number" name="" id="lasso_alpha_input" class="form-control" 
                                           value="1.0" min="0.001" max="100" step="0.1" disabled>
                                    <small class="form-text text-muted">
                                        D√º≈ü√ºk deƒüer (0.01): Zayƒ±f feature se√ßimi, y√ºksek deƒüer (10): G√º√ßl√º feature se√ßimi
                                    </small>
                                </div>
                            </div>
                        </div>

                        <!-- Eksik Veri Uyarƒ±sƒ± -->
                        {% set has_missing = false %}
                        {% for col, data in missing_data.items() %}
                            {% if data['count'] > 0 %}
                                {% set has_missing = true %}
                            {% endif %}
                        {% endfor %}

                        {% if has_missing %}
                        <div class="alert alert-warning">
                            <h6><i class="fas fa-exclamation-triangle"></i> Eksik Veri Uyarƒ±sƒ±</h6>
                            <p>Verilerinizde eksik deƒüerler bulundu. Model eƒüitimi √∂ncesi bu veriler i≈ülenecek:</p>
                            <ul class="mb-0">
                                {% for col, data in missing_data.items() %}
                                {% if data['count'] > 0 %}
                                <li><strong>{{ col }}</strong>: {{ data['count'] }} eksik veri ({{ data['percentage'] }}%)</li>
                                {% endif %}
                                {% endfor %}
                            </ul>
                        </div>
                        {% endif %}

                        <!-- Butonlar -->
                        <div class="row mt-4">
                            <div class="col-12">
                                <div class="d-flex justify-content-between">
                                    <a href="{{ url_for('processing.select_columns', filename=filename) }}" class="btn btn-secondary">
                                        <i class="fas fa-arrow-left"></i> Geri
                                    </a>
                                    <button type="submit" class="btn btn-success btn-lg">
                                        <i class="fas fa-play"></i> Modeli Eƒüit
                                    </button>
                                </div>
                            </div>
                        </div>
                    </form>
                    {% endif %}

                </div>
            </div>
        </div>
    </div>
</div>

<script>
// Model t√ºr√º hakkƒ±nda bilgi g√∂ster ve parametreleri kontrol et
document.getElementById('model_type').addEventListener('change', function() {
    const modelInfo = {
        'linear_regression': 'Basit ve hƒ±zlƒ±. Doƒürusal ili≈ükiler i√ßin uygun.',
        'ridge': 'Linear regression + L2 d√ºzenleme. Overfitting\'i √∂nler.',
        'lasso': 'Linear regression + L1 d√ºzenleme. Feature se√ßimi yapar.',
        'random_forest': 'G√º√ßl√º ve kararlƒ±. √áoƒüu veri i√ßin iyi sonu√ß verir.',
        'xgboost': '√áok g√º√ßl√º ama yava≈ü. Yarƒ±≈ümalarda pop√ºler.',
        'decision_tree': 'Anla≈üƒ±lmasƒ± kolay ama bazen kararsƒ±z.'
    };
    
    const selectedModel = this.value;
    const info = modelInfo[selectedModel];
    const infoElement = document.getElementById('model-info');
    infoElement.textContent = info;
    
    // Model parametrelerini g√∂ster/gizle
    const ridgeAlphaParam = document.getElementById('ridge-alpha-param');
    const lassoAlphaParam = document.getElementById('lasso-alpha-param');
    const ridgeInput = document.getElementById('ridge_alpha_input');
    const lassoInput = document.getElementById('lasso_alpha_input');
    
    // T√ºm parametreleri gizle ve devre dƒ±≈üƒ± bƒ±rak
    ridgeAlphaParam.style.display = 'none';
    lassoAlphaParam.style.display = 'none';
    ridgeInput.name = '';
    lassoInput.name = '';
    ridgeInput.disabled = true;
    lassoInput.disabled = true;
    
    // Se√ßili modele g√∂re parametreleri g√∂ster ve aktif et
    if (selectedModel === 'ridge') {
        ridgeAlphaParam.style.display = 'block';
        ridgeInput.name = 'alpha';
        ridgeInput.disabled = false;
    } else if (selectedModel === 'lasso') {
        lassoAlphaParam.style.display = 'block';
        lassoInput.name = 'alpha';
        lassoInput.disabled = false;
    }
});

// Sayfa y√ºklendiƒüinde mevcut se√ßimi kontrol et
document.addEventListener('DOMContentLoaded', function() {
    const modelSelect = document.getElementById('model_type');
    if (modelSelect) {
        modelSelect.dispatchEvent(new Event('change'));
    }
    
    // Form submit debug
    const trainForm = document.querySelector('form[action*="train_model"]');
    if (trainForm) {
        console.log('‚úÖ Train model formu bulundu!');
        trainForm.addEventListener('submit', function(e) {
            console.log('üöÄ Form submit edildi!');
        });
    } else {
        console.log('‚ùå Train model formu bulunamadƒ±!');
        console.log('Mevcut formlar:', document.querySelectorAll('form'));
    }
    
    // Prediction mode kontrol
    console.log('Prediction mode aktif mi?', {% if prediction_mode %}true{% else %}false{% endif %});
});
</script>
{% endblock %}
