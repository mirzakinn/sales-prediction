{% extends "base.html" %}

{% block title %}Model Ayarları - Tahmin{% endblock %}

{% block content %}
<div class="container">
    <div class="row">
        <div class="col-lg-12">
            <div class="card">
                <div class="card-header">
                    <h3 class="card-title">
                        <i class="fas fa-cogs"></i>
                        Model Konfigürasyonu
                    </h3>
                    <p class="card-subtitle">Dosya: <strong>{{ filename }}</strong> | Toplam: {{ total_rows }} satır</p>
                </div>
                <div class="card-body">
                    
                    <!-- Seçim Özeti -->
                    <div class="row mb-4">
                        <div class="col-md-6">
                            <div class="alert alert-info">
                                <h6><i class="fas fa-bullseye"></i> Hedef Kolon</h6>
                                <strong>{{ target_column }}</strong>
                                {% if missing_data[target_column]['count'] > 0 %}
                                <br><small class="text-warning">⚠️ {{ missing_data[target_column]['count'] }} eksik veri ({{ missing_data[target_column]['percentage'] }}%)</small>
                                {% endif %}
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="alert alert-success">
                                <h6><i class="fas fa-list-check"></i> Özellik Kolonları</h6>
                                {% for feature in feature_columns %}
                                <strong>{{ feature }}</strong>{% if not loop.last %}, {% endif %}
                                {% if missing_data[feature]['count'] > 0 %}
                                <br><small class="text-warning">⚠️ {{ missing_data[feature]['count'] }} eksik veri ({{ missing_data[feature]['percentage'] }}%)</small>
                                {% endif %}
                                {% endfor %}
                            </div>
                        </div>
                    </div>

                    <!-- Model Ayarları Formu -->
                    {% if prediction_mode %}
                    <!-- PREDICTION MODE: Model eğitimi yok, sadece devam et -->
                    <div class="alert alert-info">
                        <h6><i class="fas fa-info-circle"></i> Tahmin Modu</h6>
                        <p>Mevcut eğitilmiş model kullanılacak. Yeni model eğitimi yapılmayacak.</p>
                        <p><strong>Model:</strong> {{ session.prediction_model.model_type|title if session.prediction_model else 'Bilinmiyor' }}</p>
                    </div>
                    
                    <form method="POST">
                        <!-- Butonlar -->
                        <div class="row mt-4">
                            <div class="col-12">
                                <div class="d-flex justify-content-between">
                                    <a href="{{ url_for('processing.select_columns', filename=filename) }}" class="btn btn-secondary">
                                        <i class="fas fa-arrow-left"></i> Geri
                                    </a>
                                    <button type="submit" class="btn btn-primary btn-lg">
                                        <i class="fas fa-calculator"></i> Tahmin Yap
                                    </button>
                                </div>
                            </div>
                        </div>
                    </form>
                    
                    {% else %}
                    <!-- NORMAL MODE: Model eğitimi -->
                    <form method="POST" action="{{ url_for('training_model.train_model') }}" id="trainForm">
                        <div class="row">
                            <!-- Model Türü -->
                            <div class="col-md-4">
                                <div class="form-group">
                                    <label for="model_type">
                                        <i class="fas fa-robot"></i>
                                        Model Türü
                                    </label>
                                    <select name="model_type" id="model_type" class="form-control" required>
                                        <option value="linear_regression">Linear Regression</option>
                                        <option value="ridge">Ridge Regression</option>
                                        <option value="lasso">Lasso Regression</option>
                                        <option value="elasticnet">ElasticNet Regression</option>
                                        <option value="knn">KNN Regression</option>
                                        <option value="svr">SVR (Support Vector Regression)</option>
                                        <option value="decision_tree">Decision Tree</option>
                                        <option value="random_forest">Random Forest</option>
                                        <option value="xgboost">XGBoost</option>
                                        <option value="lightgbm">LightGBM</option>
                                    </select>
                                    <small class="form-text text-muted" id="model-info">
                                        Başlangıç için Linear Regression önerilir.
                                    </small>
                                </div>
                            </div>

                            <!-- Test Veri Oranı -->
                            <div class="col-md-4">
                                <div class="form-group">
                                    <label for="test_size">
                                        <i class="fas fa-chart-pie"></i>
                                        Test Veri Oranı
                                    </label>
                                    <select name="test_size" id="test_size" class="form-control">
                                        <option value="0.1">%10 (Daha çok eğitim verisi)</option>
                                        <option value="0.2" selected>%20 (Önerilen)</option>
                                        <option value="0.3">%30 (Daha çok test verisi)</option>
                                    </select>
                                    <small class="form-text text-muted">
                                        Verinin ne kadarı test için ayrılacak.
                                    </small>
                                </div>
                            </div>

                            <!-- Eksik Veri İşleme -->
                            <div class="col-md-4">
                                <div class="form-group">
                                    <label for="handle_missing">
                                        <i class="fas fa-question-circle"></i>
                                        Eksik Veri İşleme
                                    </label>
                                    <select name="handle_missing" id="handle_missing" class="form-control">
                                        <option value="drop">Eksik satırları sil</option>
                                        <option value="mean">Ortalama ile doldur</option>
                                        <option value="median">Medyan ile doldur</option>
                                    </select>
                                    <small class="form-text text-muted">
                                        Eksik veriler nasıl işlensin?
                                    </small>
                                </div>
                            </div>
                        </div>

                        <!-- Model Parametreleri (Dinamik) -->
                        <div class="row" id="manualParamsSection">
                            <!-- İlk Parametre Sütunu -->
                            <div class="col-md-4" id="model-params-container">
                                <!-- Linear Regression Fit Intercept -->
                                <div class="form-group" id="linear-fit-intercept-param" style="display: none;">
                                    <label for="fit_intercept_input">
                                        <i class="fas fa-toggle-on"></i>
                                        Fit Intercept
                                    </label>
                                    <select name="" id="fit_intercept_input" class="form-control" disabled>
                                        <option value="true" selected>True (Kesme noktası ekle)</option>
                                        <option value="false">False (Orijinden geç)</option>
                                    </select>
                                    <small class="form-text text-muted">
                                        True: Modele sabit terim eklenir
                                    </small>
                                </div>

                                <!-- Ridge Alpha Parametresi -->
                                <div class="form-group" id="ridge-alpha-param" style="display: none;">
                                    <label for="ridge_alpha_input">
                                        <i class="fas fa-sliders-h"></i>
                                        Alpha (Düzenleme Katsayısı)
                                    </label>
                                    <input type="number" name="" id="ridge_alpha_input" class="form-control" 
                                           value="1.0" min="0.001" max="100" step="0.1" disabled>
                                    <small class="form-text text-muted">
                                        Düşük değer (0.1): Az düzenleme, yüksek değer (10): Çok düzenleme
                                    </small>
                                </div>
                                
                                <!-- Lasso Alpha Parametresi -->
                                <div class="form-group" id="lasso-alpha-param" style="display: none;">
                                    <label for="lasso_alpha_input">
                                        <i class="fas fa-sliders-h"></i>
                                        Alpha (L1 Düzenleme Katsayısı)
                                    </label>
                                    <input type="number" name="" id="lasso_alpha_input" class="form-control" 
                                           value="1.0" min="0.001" max="100" step="0.1" disabled>
                                    <small class="form-text text-muted">
                                        Düşük değer (0.01): Zayıf feature seçimi, yüksek değer (10): Güçlü feature seçimi
                                    </small>
                                </div>
                                
                                <!-- ElasticNet Alpha Parametresi -->
                                <div class="form-group" id="elasticnet-alpha-param" style="display: none;">
                                    <label for="elasticnet_alpha_input">
                                        <i class="fas fa-sliders-h"></i>
                                        Alpha (Düzenleme Katsayısı)
                                    </label>
                                    <input type="number" name="" id="elasticnet_alpha_input" class="form-control" 
                                           value="1.0" min="0.001" max="100" step="0.1" disabled>
                                    <small class="form-text text-muted">
                                        Düşük değer (0.1): Az düzenleme, yüksek değer (10): Çok düzenleme
                                    </small>
                                </div>
                                
                                <!-- KNN N_Neighbors Parametresi -->
                                <div class="form-group" id="knn-neighbors-param" style="display: none;">
                                    <label for="n_neighbors_input">
                                        <i class="fas fa-users"></i>
                                        Komşu Sayısı (K)
                                    </label>
                                    <input type="number" name="" id="n_neighbors_input" class="form-control" 
                                           value="5" min="1" max="50" step="1" disabled>
                                    <small class="form-text text-muted">
                                        Düşük değer (3): Daha esnek, yüksek değer (15): Daha stabil
                                    </small>
                                </div>

                                <!-- SVR C Parametresi -->
                                <div class="form-group" id="svr-c-param" style="display: none;">
                                    <label for="svr_c_input">
                                        <i class="fas fa-sliders-h"></i>
                                        C (Düzenleme Parametresi)
                                    </label>
                                    <input type="number" name="" id="svr_c_input" class="form-control" 
                                           value="1.0" min="0.001" max="1000" step="0.1" disabled>
                                    <small class="form-text text-muted">
                                        Düşük değer (0.1): Daha yumuşak, yüksek değer (100): Daha sert
                                    </small>
                                </div>

                                <!-- Decision Tree Max Depth -->
                                <div class="form-group" id="dt-max-depth-param" style="display: none;">
                                    <label for="dt_max_depth_input">
                                        <i class="fas fa-sitemap"></i>
                                        Max Depth (Maksimum Derinlik)
                                    </label>
                                    <input type="number" name="" id="dt_max_depth_input" class="form-control" 
                                           value="" min="1" max="50" step="1" placeholder="None (Sınırsız)" disabled>
                                    <small class="form-text text-muted">
                                        Boş: Sınırsız, düşük değer (3): Basit ağaç, yüksek değer (20): Karmaşık ağaç
                                    </small>
                                </div>

                                <!-- Random Forest N Estimators -->
                                <div class="form-group" id="rf-n-estimators-param" style="display: none;">
                                    <label for="rf_n_estimators_input">
                                        <i class="fas fa-tree"></i>
                                        N Estimators (Ağaç Sayısı)
                                    </label>
                                    <input type="number" name="" id="rf_n_estimators_input" class="form-control" 
                                           value="100" min="10" max="1000" step="10" disabled>
                                    <small class="form-text text-muted">
                                        Düşük değer (50): Hızlı, yüksek değer (500): Daha doğru ama yavaş
                                    </small>
                                </div>

                                <!-- XGBoost N Estimators -->
                                <div class="form-group" id="xgb-n-estimators-param" style="display: none;">
                                    <label for="xgb_n_estimators_input">
                                        <i class="fas fa-tree"></i>
                                        N Estimators (Ağaç Sayısı)
                                    </label>
                                    <input type="number" name="" id="xgb_n_estimators_input" class="form-control" 
                                           value="100" min="10" max="1000" step="10" disabled>
                                    <small class="form-text text-muted">
                                        Düşük değer (50): Hızlı, yüksek değer (500): Daha doğru ama yavaş
                                    </small>
                                </div>

                                <!-- LightGBM N Estimators -->
                                <div class="form-group" id="lgb-n-estimators-param" style="display: none;">
                                    <label for="lgb_n_estimators_input">
                                        <i class="fas fa-tree"></i>
                                        N Estimators (Ağaç Sayısı)
                                    </label>
                                    <input type="number" name="" id="lgb_n_estimators_input" class="form-control" 
                                           value="100" min="10" max="1000" step="10" disabled>
                                    <small class="form-text text-muted">
                                        Düşük değer (50): Hızlı, yüksek değer (500): Daha doğru
                                    </small>
                                </div>
                            </div>
                            
                            <!-- İkinci Parametre Sütunu -->
                            <div class="col-md-4">
                                <!-- Linear Regression Positive -->
                                <div class="form-group" id="linear-positive-param" style="display: none;">
                                    <label for="positive_input">
                                        <i class="fas fa-plus"></i>
                                        Positive (Pozitif Katsayılar)
                                    </label>
                                    <select name="" id="positive_input" class="form-control" disabled>
                                        <option value="false" selected>False (Negatif katsayılara izin ver)</option>
                                        <option value="true">True (Sadece pozitif katsayılar)</option>
                                    </select>
                                    <small class="form-text text-muted">
                                        True: Tüm katsayılar pozitif olur
                                    </small>
                                </div>

                                <!-- Ridge Solver -->
                                <div class="form-group" id="ridge-solver-param" style="display: none;">
                                    <label for="ridge_solver_input">
                                        <i class="fas fa-cogs"></i>
                                        Solver (Çözüm Algoritması)
                                    </label>
                                    <select name="" id="ridge_solver_input" class="form-control" disabled>
                                        <option value="auto" selected>Auto (Otomatik)</option>
                                        <option value="svd">SVD</option>
                                        <option value="cholesky">Cholesky</option>
                                        <option value="lsqr">LSQR</option>
                                        <option value="sparse_cg">Sparse CG</option>
                                    </select>
                                    <small class="form-text text-muted">
                                        Auto: En uygun algoritma otomatik seçilir
                                    </small>
                                </div>

                                <!-- Lasso Max Iter -->
                                <div class="form-group" id="lasso-max-iter-param" style="display: none;">
                                    <label for="lasso_max_iter_input">
                                        <i class="fas fa-sync"></i>
                                        Max Iter (Maksimum İterasyon)
                                    </label>
                                    <input type="number" name="" id="lasso_max_iter_input" class="form-control" 
                                           value="1000" min="100" max="10000" step="100" disabled>
                                    <small class="form-text text-muted">
                                        Düşük değer (500): Hızlı ama yakınsama riski, yüksek değer (5000): Güvenli
                                    </small>
                                </div>

                                <!-- ElasticNet L1 Ratio -->
                                <div class="form-group" id="l1-ratio-param" style="display: none;">
                                    <label for="l1_ratio_input">
                                        <i class="fas fa-balance-scale"></i>
                                        L1 Ratio (L1/L2 Karışımı)
                                    </label>
                                    <input type="number" name="" id="l1_ratio_input" class="form-control" 
                                           value="0.5" min="0" max="1" step="0.1" disabled>
                                    <small class="form-text text-muted">
                                        0: Sadece Ridge (L2), 1: Sadece Lasso (L1), 0.5: Eşit karışım
                                    </small>
                                </div>
                                
                                <!-- KNN Weights Parametresi -->
                                <div class="form-group" id="knn-weights-param" style="display: none;">
                                    <label for="weights_input">
                                        <i class="fas fa-weight-hanging"></i>
                                        Ağırlık Türü
                                    </label>
                                    <select name="" id="weights_input" class="form-control" disabled>
                                        <option value="uniform">Uniform (Eşit ağırlık)</option>
                                        <option value="distance" selected>Distance (Mesafe bazlı)</option>
                                    </select>
                                    <small class="form-text text-muted">
                                        Distance: Yakın komşular daha fazla etkili
                                    </small>
                                </div>

                                <!-- SVR Gamma -->
                                <div class="form-group" id="svr-gamma-param" style="display: none;">
                                    <label for="svr_gamma_input">
                                        <i class="fas fa-wave-square"></i>
                                        Gamma (Kernel Katsayısı)
                                    </label>
                                    <select name="" id="svr_gamma_input" class="form-control" disabled>
                                        <option value="scale" selected>Scale (1/(n_features * X.var()))</option>
                                        <option value="auto">Auto (1/n_features)</option>
                                    </select>
                                    <small class="form-text text-muted">
                                        Scale: Önerilen, Auto: Basit hesaplama
                                    </small>
                                </div>

                                <!-- Decision Tree Min Samples Leaf -->
                                <div class="form-group" id="dt-min-samples-leaf-param" style="display: none;">
                                    <label for="dt_min_samples_leaf_input">
                                        <i class="fas fa-leaf"></i>
                                        Min Samples Leaf (Min Yaprak Örneği)
                                    </label>
                                    <input type="number" name="" id="dt_min_samples_leaf_input" class="form-control" 
                                           value="1" min="1" max="100" step="1" disabled>
                                    <small class="form-text text-muted">
                                        Düşük değer (1): Detaylı ağaç, yüksek değer (20): Basit ağaç
                                    </small>
                                </div>

                                <!-- Random Forest Max Depth -->
                                <div class="form-group" id="rf-max-depth-param" style="display: none;">
                                    <label for="rf_max_depth_input">
                                        <i class="fas fa-sitemap"></i>
                                        Max Depth (Maksimum Derinlik)
                                    </label>
                                    <input type="number" name="" id="rf_max_depth_input" class="form-control" 
                                           value="" min="1" max="50" step="1" placeholder="None (Sınırsız)" disabled>
                                    <small class="form-text text-muted">
                                        Boş: Sınırsız, düşük değer (5): Basit, yüksek değer (20): Karmaşık
                                    </small>
                                </div>

                                <!-- XGBoost Learning Rate -->
                                <div class="form-group" id="xgb-learning-rate-param" style="display: none;">
                                    <label for="xgb_learning_rate_input">
                                        <i class="fas fa-tachometer-alt"></i>
                                        Learning Rate (Öğrenme Hızı)
                                    </label>
                                    <input type="number" name="" id="xgb_learning_rate_input" class="form-control" 
                                           value="0.1" min="0.01" max="1.0" step="0.01" disabled>
                                    <small class="form-text text-muted">
                                        Düşük değer (0.01): Yavaş öğrenme, yüksek değer (0.3): Hızlı öğrenme
                                    </small>
                                </div>

                                <!-- LightGBM Learning Rate -->
                                <div class="form-group" id="lgb-learning-rate-param" style="display: none;">
                                    <label for="lgb_learning_rate_input">
                                        <i class="fas fa-tachometer-alt"></i>
                                        Learning Rate (Öğrenme Hızı)
                                    </label>
                                    <input type="number" name="" id="lgb_learning_rate_input" class="form-control" 
                                           value="0.1" min="0.01" max="1.0" step="0.01" disabled>
                                    <small class="form-text text-muted">
                                        Düşük değer (0.01): Yavaş öğrenme, yüksek değer (0.3): Hızlı öğrenme
                                    </small>
                                </div>
                            </div>

                            <!-- Üçüncü Parametre Sütunu -->
                            <div class="col-md-4">
                                <!-- XGBoost Max Depth -->
                                <div class="form-group" id="xgb-max-depth-param" style="display: none;">
                                    <label for="xgb_max_depth_input">
                                        <i class="fas fa-sitemap"></i>
                                        Max Depth (Maksimum Derinlik)
                                    </label>
                                    <input type="number" name="" id="xgb_max_depth_input" class="form-control" 
                                           value="6" min="1" max="20" step="1" disabled>
                                    <small class="form-text text-muted">
                                        Düşük değer (3): Basit model, yüksek değer (15): Karmaşık model
                                    </small>
                                </div>

                                <!-- LightGBM Max Depth -->
                                <div class="form-group" id="lgb-max-depth-param" style="display: none;">
                                    <label for="lgb_max_depth_input">
                                        <i class="fas fa-sitemap"></i>
                                        Max Depth (Maksimum Derinlik)
                                    </label>
                                    <input type="number" name="" id="lgb_max_depth_input" class="form-control" 
                                           value="-1" min="-1" max="20" step="1" disabled>
                                    <small class="form-text text-muted">
                                        -1: Sınırsız, düşük değer (5): Basit, yüksek değer (15): Karmaşık
                                    </small>
                                </div>

                            </div>
                        </div>

                        <!-- Eksik Veri Uyarısı -->
                        {% set has_missing = false %}
                        {% for col, data in missing_data.items() %}
                            {% if data['count'] > 0 %}
                                {% set has_missing = true %}
                            {% endif %}
                        {% endfor %}

                        {% if has_missing %}
                        <div class="alert alert-warning">
                            <h6><i class="fas fa-exclamation-triangle"></i> Eksik Veri Uyarısı</h6>
                            <p>Verilerinizde eksik değerler bulundu. Model eğitimi öncesi bu veriler işlenecek:</p>
                            <ul class="mb-0">
                                {% for col, data in missing_data.items() %}
                                {% if data['count'] > 0 %}
                                <li><strong>{{ col }}</strong>: {{ data['count'] }} eksik veri ({{ data['percentage'] }}%)</li>
                                {% endif %}
                                {% endfor %}
                            </ul>
                        </div>
                        {% endif %}

                        <!-- Otomatik Seçenekler -->
                        <div class="row mb-4">
                            <div class="col-12">
                                <!-- En İyi Model Otomatik Seçimi -->
                                <div class="card border-success mb-3">
                                    <div class="card-body">
                                        <div class="form-check">
                                            <input class="form-check-input" type="checkbox" id="useAutoModelSelection" name="use_auto_model_selection">
                                            <label class="form-check-label fw-bold" for="useAutoModelSelection">
                                                <i class="fas fa-crown text-success"></i> En İyi Modeli ve Parametreleri Otomatik Bul (Tüm Algoritmalar)
                                            </label>
                                        </div>
                                        <div class="form-check mt-2" id="detailedModeSection" style="display: none;">
                                            <input class="form-check-input" type="checkbox" id="useDetailedMode" name="use_detailed_mode">
                                            <label class="form-check-label" for="useDetailedMode">
                                                <i class="fas fa-microscope text-warning"></i> <strong>Detaylı Mod</strong> (Daha kapsamlı parametre arama)
                                            </label>
                                            <div class="alert alert-warning mt-2 mb-0" style="font-size: 0.85em;">
                                                <i class="fas fa-clock"></i> <strong>Uyarı:</strong> Detaylı mod <strong>5-10 dakika</strong> sürebilir! 
                                                Daha fazla parametre kombinasyonu test ederek %5-15 daha iyi sonuç verebilir.
                                            </div>
                                        </div>
                                        <small class="text-muted">
                                            <strong>Tüm algoritmaları</strong> (Linear, Ridge, Lasso, ElasticNet, KNN, SVR, Decision Tree, Random Forest, XGBoost, LightGBM) 
                                            test ederek en yüksek performansı veren modeli ve parametrelerini otomatik bulur. 
                                            Bu seçenek aktifken model seçimi ve parametre girişi devre dışı kalır.
                                        </small>
                                    </div>
                                </div>
                                
                                <!-- GridSearch Seçeneği -->
                                <div class="card border-primary">
                                    <div class="card-body">
                                        <div class="form-check">
                                            <input class="form-check-input" type="checkbox" id="useGridSearch" name="use_grid_search">
                                            <label class="form-check-label fw-bold" for="useGridSearch">
                                                <i class="fas fa-magic text-primary"></i> Seçili Model İçin En İyi Parametreleri Bul (GridSearch)
                                            </label>
                                        </div>
                                        <small class="text-muted">
                                            Seçili algoritma için farklı parametre kombinasyonları denenerek en iyi sonucu veren ayarlar otomatik bulunur. 
                                            Bu seçenek aktifken manuel parametre girişi devre dışı kalır.
                                        </small>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Butonlar -->
                        <div class="row mt-4">
                            <div class="col-12">
                                <div class="d-flex justify-content-between">
                                    <a href="{{ url_for('processing.select_columns', filename=filename) }}" class="btn btn-secondary">
                                        <i class="fas fa-arrow-left"></i> Geri
                                    </a>
                                    <button type="submit" class="btn btn-success btn-lg" id="trainButton">
                                        <i class="fas fa-play"></i> Modeli Eğit
                                    </button>
                                </div>
                            </div>
                        </div>
                    </form>
                    {% endif %}

                </div>
            </div>
        </div>
    </div>
</div>

<script>
// Model türü hakkında bilgi göster ve parametreleri kontrol et
document.getElementById('model_type').addEventListener('change', function() {
    const modelInfo = {
        'linear_regression': 'Basit ve hızlı. Doğrusal ilişkiler için uygun.',
        'ridge': 'Linear regression + L2 düzenleme. Overfitting\'i önler.',
        'lasso': 'Linear regression + L1 düzenleme. Feature seçimi yapar.',
        'elasticnet': 'Ridge + Lasso kombinasyonu. Güçlü ve esnek düzenleme.',
        'knn': 'Komşu tabanlı tahmin. Yerel kalıpları iyi yakalar.',
        'svr': 'Güçlü ve esnek. Doğrusal olmayan ilişkiler için uygun.',
        'decision_tree': 'Anlaşılması kolay ama bazen kararsız.',
        'random_forest': 'Güçlü ve kararlı. Çoğu veri için iyi sonuç verir.',
        'xgboost': 'Çok güçlü ama yavaş. Yarışmalarda popüler.',
        'lightgbm': 'Hızlı ve güçlü gradient boosting. XGBoost\'a alternatif.'
    };
    
    const selectedModel = this.value;
    const info = modelInfo[selectedModel];
    const infoElement = document.getElementById('model-info');
    infoElement.textContent = info;
    
    // Tüm parametre elementlerini al
    const allParams = [
        'linear-fit-intercept-param', 'linear-positive-param',
        'ridge-alpha-param', 'ridge-solver-param',
        'lasso-alpha-param', 'lasso-max-iter-param',
        'elasticnet-alpha-param', 'l1-ratio-param',
        'knn-neighbors-param', 'knn-weights-param',
        'svr-c-param', 'svr-gamma-param',
        'dt-max-depth-param', 'dt-min-samples-leaf-param',
        'rf-n-estimators-param', 'rf-max-depth-param',
        'xgb-n-estimators-param', 'xgb-learning-rate-param', 'xgb-max-depth-param',
        'lgb-n-estimators-param', 'lgb-learning-rate-param', 'lgb-max-depth-param'
    ];
    
    const allInputs = [
        'fit_intercept_input', 'positive_input',
        'ridge_alpha_input', 'ridge_solver_input',
        'lasso_alpha_input', 'lasso_max_iter_input',
        'elasticnet_alpha_input', 'l1_ratio_input',
        'n_neighbors_input', 'weights_input',
        'svr_c_input', 'svr_gamma_input',
        'dt_max_depth_input', 'dt_min_samples_leaf_input',
        'rf_n_estimators_input', 'rf_max_depth_input',
        'xgb_n_estimators_input', 'xgb_learning_rate_input', 'xgb_max_depth_input',
        'lgb_n_estimators_input', 'lgb_learning_rate_input', 'lgb_max_depth_input'
    ];
    
    // Tüm parametreleri gizle ve devre dışı bırak
    allParams.forEach(paramId => {
        const param = document.getElementById(paramId);
        if (param) param.style.display = 'none';
    });
    
    allInputs.forEach(inputId => {
        const input = document.getElementById(inputId);
        if (input) {
            input.name = '';
            input.disabled = true;
        }
    });
    
    // Seçili modele göre parametreleri göster ve aktif et
    if (selectedModel === 'linear_regression') {
        document.getElementById('linear-fit-intercept-param').style.display = 'block';
        document.getElementById('linear-positive-param').style.display = 'block';
        document.getElementById('fit_intercept_input').name = 'fit_intercept';
        document.getElementById('positive_input').name = 'positive';
        document.getElementById('fit_intercept_input').disabled = false;
        document.getElementById('positive_input').disabled = false;
    } else if (selectedModel === 'ridge') {
        document.getElementById('ridge-alpha-param').style.display = 'block';
        document.getElementById('ridge-solver-param').style.display = 'block';
        document.getElementById('ridge_alpha_input').name = 'alpha';
        document.getElementById('ridge_solver_input').name = 'solver';
        document.getElementById('ridge_alpha_input').disabled = false;
        document.getElementById('ridge_solver_input').disabled = false;
    } else if (selectedModel === 'lasso') {
        document.getElementById('lasso-alpha-param').style.display = 'block';
        document.getElementById('lasso-max-iter-param').style.display = 'block';
        document.getElementById('lasso_alpha_input').name = 'alpha';
        document.getElementById('lasso_max_iter_input').name = 'max_iter';
        document.getElementById('lasso_alpha_input').disabled = false;
        document.getElementById('lasso_max_iter_input').disabled = false;
    } else if (selectedModel === 'elasticnet') {
        document.getElementById('elasticnet-alpha-param').style.display = 'block';
        document.getElementById('l1-ratio-param').style.display = 'block';
        document.getElementById('elasticnet_alpha_input').name = 'alpha';
        document.getElementById('l1_ratio_input').name = 'l1_ratio';
        document.getElementById('elasticnet_alpha_input').disabled = false;
        document.getElementById('l1_ratio_input').disabled = false;
    } else if (selectedModel === 'knn') {
        document.getElementById('knn-neighbors-param').style.display = 'block';
        document.getElementById('knn-weights-param').style.display = 'block';
        document.getElementById('n_neighbors_input').name = 'n_neighbors';
        document.getElementById('weights_input').name = 'weights';
        document.getElementById('n_neighbors_input').disabled = false;
        document.getElementById('weights_input').disabled = false;
    } else if (selectedModel === 'svr') {
        document.getElementById('svr-c-param').style.display = 'block';
        document.getElementById('svr-gamma-param').style.display = 'block';
        document.getElementById('svr_c_input').name = 'C';
        document.getElementById('svr_gamma_input').name = 'gamma';
        document.getElementById('svr_c_input').disabled = false;
        document.getElementById('svr_gamma_input').disabled = false;
    } else if (selectedModel === 'decision_tree') {
        document.getElementById('dt-max-depth-param').style.display = 'block';
        document.getElementById('dt-min-samples-leaf-param').style.display = 'block';
        document.getElementById('dt_max_depth_input').name = 'max_depth';
        document.getElementById('dt_min_samples_leaf_input').name = 'min_samples_leaf';
        document.getElementById('dt_max_depth_input').disabled = false;
        document.getElementById('dt_min_samples_leaf_input').disabled = false;
    } else if (selectedModel === 'random_forest') {
        document.getElementById('rf-n-estimators-param').style.display = 'block';
        document.getElementById('rf-max-depth-param').style.display = 'block';
        document.getElementById('rf_n_estimators_input').name = 'n_estimators';
        document.getElementById('rf_max_depth_input').name = 'max_depth';
        document.getElementById('rf_n_estimators_input').disabled = false;
        document.getElementById('rf_max_depth_input').disabled = false;
    } else if (selectedModel === 'xgboost') {
        document.getElementById('xgb-n-estimators-param').style.display = 'block';
        document.getElementById('xgb-learning-rate-param').style.display = 'block';
        document.getElementById('xgb-max-depth-param').style.display = 'block';
        document.getElementById('xgb_n_estimators_input').name = 'n_estimators';
        document.getElementById('xgb_learning_rate_input').name = 'learning_rate';
        document.getElementById('xgb_max_depth_input').name = 'max_depth';
        document.getElementById('xgb_n_estimators_input').disabled = false;
        document.getElementById('xgb_learning_rate_input').disabled = false;
        document.getElementById('xgb_max_depth_input').disabled = false;
    } else if (selectedModel === 'lightgbm') {
        document.getElementById('lgb-n-estimators-param').style.display = 'block';
        document.getElementById('lgb-learning-rate-param').style.display = 'block';
        document.getElementById('lgb-max-depth-param').style.display = 'block';
        document.getElementById('lgb_n_estimators_input').name = 'n_estimators';
        document.getElementById('lgb_learning_rate_input').name = 'learning_rate';
        document.getElementById('lgb_max_depth_input').name = 'max_depth';
        document.getElementById('lgb_n_estimators_input').disabled = false;
        document.getElementById('lgb_learning_rate_input').disabled = false;
        document.getElementById('lgb_max_depth_input').disabled = false;
    }
});

// Auto Model Selection checkbox işlevi
document.getElementById('useAutoModelSelection')?.addEventListener('change', function() {
    const isAutoEnabled = this.checked;
    const modelTypeSelect = document.getElementById('model_type');
    const gridSearchCheckbox = document.getElementById('useGridSearch');
    const manualParamsSection = document.getElementById('manualParamsSection');
    const detailedModeSection = document.getElementById('detailedModeSection');
    
    if (isAutoEnabled) {
        // Auto Model Selection aktifken tüm seçenekleri devre dışı bırak
        modelTypeSelect.disabled = true;
        modelTypeSelect.style.opacity = '0.5';
        
        gridSearchCheckbox.checked = false;
        gridSearchCheckbox.disabled = true;
        gridSearchCheckbox.parentElement.style.opacity = '0.5';
        
        manualParamsSection.style.opacity = '0.3';
        manualParamsSection.style.pointerEvents = 'none';
        
        // Detaylı mod seçeneğini göster
        detailedModeSection.style.display = 'block';
        
        // Tüm parametreleri gizle
        const allParams = document.querySelectorAll('[id$="-param"]');
        allParams.forEach(param => {
            if (param) param.style.display = 'none';
        });
        
    } else {
        // Auto Model Selection kapatıldığında seçenekleri geri aç
        modelTypeSelect.disabled = false;
        modelTypeSelect.style.opacity = '1';
        
        gridSearchCheckbox.disabled = false;
        gridSearchCheckbox.parentElement.style.opacity = '1';
        
        manualParamsSection.style.opacity = '1';
        manualParamsSection.style.pointerEvents = 'auto';
        
        // Detaylı mod seçeneğini gizle
        detailedModeSection.style.display = 'none';
        document.getElementById('useDetailedMode').checked = false;
        
        // Seçili modelin parametrelerini göster
        modelTypeSelect.dispatchEvent(new Event('change'));
    }
});

// GridSearch checkbox işlevi
document.getElementById('useGridSearch')?.addEventListener('change', function() {
    const isGridSearchEnabled = this.checked;
    const autoModelCheckbox = document.getElementById('useAutoModelSelection');
    const manualParamsSection = document.getElementById('manualParamsSection');
    
    // Auto Model Selection aktifse GridSearch'ü engelle
    if (autoModelCheckbox.checked) {
        this.checked = false;
        return;
    }
    
    if (isGridSearchEnabled) {
        // GridSearch aktifken manuel parametreleri devre dışı bırak
        manualParamsSection.style.opacity = '0.5';
        manualParamsSection.style.pointerEvents = 'none';
        
        // Tüm input'ları devre dışı bırak
        const inputs = manualParamsSection.querySelectorAll('input, select');
        inputs.forEach(input => {
            input.disabled = true;
            input.removeAttribute('name'); // Form submit'te gönderilmesin
        });
    } else {
        // Manuel parametreler aktif
        manualParamsSection.style.opacity = '1';
        manualParamsSection.style.pointerEvents = 'auto';
        
        // Mevcut model için gerekli input'ları aktif et
        const modelSelect = document.getElementById('model_type');
        if (modelSelect) {
            modelSelect.dispatchEvent(new Event('change'));
        }
    }
});

// Sayfa yüklendiğinde mevcut seçimi kontrol et
document.addEventListener('DOMContentLoaded', function() {
    const modelSelect = document.getElementById('model_type');
    if (modelSelect) {
        modelSelect.dispatchEvent(new Event('change'));
    }
});

// Model eğitimi form submit işlemi
document.getElementById('trainForm')?.addEventListener('submit', function(e) {
    // Yükleme ekranını göster
    showTrainingLoading();
    
    // Butonu devre dışı bırak
    const trainButton = document.getElementById('trainButton');
    trainButton.disabled = true;
    trainButton.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Model Eğitiliyor...';
});

// Model eğitimi yükleme ekranı
function showTrainingLoading() {
    const loadingHtml = `
        <div class="loading-overlay" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 9999; display: flex; align-items: center; justify-content: center;">
            <div class="text-center text-white">
                <div class="spinner-border text-light mb-3" role="status" style="width: 4rem; height: 4rem;">
                    <span class="visually-hidden">Eğitiliyor...</span>
                </div>
                <h4 class="mb-2">Model Eğitiliyor</h4>
                <p class="mb-3">Bu işlem birkaç dakika sürebilir...</p>
                <small class="text-muted mt-2 d-block">Lütfen sayfayı kapatmayın</small>
            </div>
        </div>
    `;
    document.body.insertAdjacentHTML('beforeend', loadingHtml);
}
</script>
{% endblock %}
